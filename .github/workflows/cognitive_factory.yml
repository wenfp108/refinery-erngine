name: ğŸ§  Cognitive Factory (Event Driven)

# ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šç›‘å¬ "ğŸš€ Refinery Engine (Hourly)" çš„ç»“æŸäº‹ä»¶
# è¿™æ ·å®ç°äº†çœŸæ­£çš„ "Pipeline"ï¼ˆæµæ°´çº¿ï¼‰æ¨¡å¼ï¼Œç»å¯¹ä¸ä¼šæ’è½¦
on:
  workflow_run:
    workflows: ["ğŸš€ Refinery Engine (Hourly)"] # å¿…é¡»ä¸ refinery.yml é‡Œçš„ name å®Œå…¨ä¸€è‡´
    types:
      - completed
  workflow_dispatch:      # ä¿ç•™æ‰‹åŠ¨æŒ‰é’®ï¼Œæ–¹ä¾¿æµ‹è¯•

jobs:
  audit_and_ship:
    # åªæœ‰å½“æŠ“å–ä»»åŠ¡æˆåŠŸæ—¶æ‰è¿è¡Œ (é˜²æ­¢æŠ“å–å¤±è´¥äº†è¿˜å»åŠ å·¥ç©ºæ•°æ®)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write     # å…è®¸æäº¤ä»£ç åˆ°ä¸­å¤®é“¶è¡Œ

    steps:
      # 1ï¸âƒ£ æ£€å‡ºåŠ å·¥å‚ (Refinery-Engine) - å½“å‰ä»“åº“
      - name: Checkout Refinery (Self)
        uses: actions/checkout@v4
        with:
          path: refinery

      # 2ï¸âƒ£ æ£€å‡ºå¤§å¸ˆé€»è¾‘ (Masters-Council) - ç§æœ‰åº“
      - name: Checkout Masters (Logic)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Masters-Council
          token: ${{ secrets.GH_PAT }}
          path: masters_repo

      # 3ï¸âƒ£ æ£€å‡ºä¸­å¤®é“¶è¡Œ (Central-Bank) - ç§æœ‰åº“
      - name: Checkout Vault (Storage)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.GH_PAT }}
          path: vault

      # 4ï¸âƒ£ ç¯å¢ƒå‡†å¤‡ï¼šè£…è½½å¤§å¸ˆæ’ä»¶å¹¶å®‰è£…å¢å¼ºç‰ˆä¾èµ–
      - name: Setup Environment
        run: |
          # åˆ›å»ºå­˜æ”¾æ’ä»¶çš„ç›®å½•å¹¶å¤åˆ¶
          mkdir -p refinery/masters
          cp -r masters_repo/masters/*.py refinery/masters/
          echo "âœ… å¤§å¸ˆæ’ä»¶è£…è½½å®Œæ¯•"
          
          # è®¾ç½® Python ç¯å¢ƒ
          echo "python_version=3.9" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          # âœ… è¡¥å……äº† requests (ç”¨äºAPIè°ƒç”¨) å’Œ pytz (ç”¨äºæ—¶åŒºå¤„ç†)
          pip install pandas pyarrow supabase PyGithub requests pytz

      # 5ï¸âƒ£ å¯åŠ¨è®¤çŸ¥å·¥å‚ï¼šæ³¨å…¥æ ¸å¿ƒ Secrets
      - name: Run Cognitive Factory
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          # âœ… å¿…é¡»æ³¨å…¥æ­¤å˜é‡ï¼Œå¦åˆ™å¤§å¸ˆä¼šæŠ¥ API_ERROR
          SILICON_FLOW_KEY: ${{ secrets.SILICON_FLOW_KEY }} 
        run: |
          cd refinery
          # è¿è¡Œè°ƒåº¦è„šæœ¬ï¼Œå¼€å§‹åŠ å·¥æœ€è¿‘1å°æ—¶çš„æ•°æ®
          python run_factory.py

      # 6ï¸âƒ£ èµ„äº§å…¥åº“ï¼šå°†ç”Ÿæˆçš„ jsonl æ°¸ä¹…å­˜å…¥ä¸­å¤®é“¶è¡Œ
      - name: Ship to Central Bank
        run: |
          cd vault
          # é…ç½® Bot èº«ä»½
          git config --global user.name "Cognitive Bot"
          git config --global user.email "bot@wenfp108.com"
          
          # æ£€æŸ¥ instructions/ ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–°äº§ç”Ÿçš„è®¤çŸ¥èµ„äº§ (jsonl)
          # æ³¨æ„ï¼šfactory.py ä¼šæŒ‰æœˆç”Ÿæˆæ–‡ä»¶åï¼Œå¦‚ teachings_202602.jsonl
          if [[ -n $(git status -s instructions/) ]]; then
            git add instructions/
            git commit -m "ğŸ§  Cognitive Audit: New insights generated at $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… é¡¶çº§è®¤çŸ¥èµ„äº§å·²æŠ¼è¿è‡³ä¸­å¤®é“¶è¡Œã€‚"
          else
            echo "ğŸ’¤ æœ¬è½®æ‰«ææœªå‘ç°è¶³å¤Ÿè§¦å‘å¤§å¸ˆå®¡è®¡çš„ä¿¡å· (æ— å˜åŠ¨)ã€‚"
          fi
