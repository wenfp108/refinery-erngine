name: ğŸ§  Cognitive Factory (Event Driven)

# ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šç›‘å¬ "Refinery Engine" çš„ç»“æŸäº‹ä»¶
# è¿™æ ·å®ç°äº†çœŸæ­£çš„ "Pipeline"ï¼ˆæµæ°´çº¿ï¼‰æ¨¡å¼ï¼Œç»å¯¹ä¸ä¼šæ’è½¦
on:
  workflow_run:
    workflows: ["ğŸš€ Refinery Engine (Hourly)"] # å¿…é¡»ä¸ refinery.yml é‡Œçš„ name å®Œå…¨ä¸€è‡´
    types:
      - completed
  workflow_dispatch:      # ä¿ç•™æ‰‹åŠ¨æŒ‰é’®ï¼Œæ–¹ä¾¿æµ‹è¯•

jobs:
  audit_and_ship:
    # åªæœ‰å½“æŠ“å–ä»»åŠ¡æˆåŠŸæ—¶æ‰è¿è¡Œ (é˜²æ­¢æŠ“å–å¤±è´¥äº†è¿˜å»åŠ å·¥ç©ºæ•°æ®)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write     # å…è®¸æäº¤ä»£ç 

    steps:
      # 1ï¸âƒ£ æ£€å‡ºåŠ å·¥å‚ (Refinery-Engine) - ä¹Ÿå°±æ˜¯å½“å‰ä»“åº“
      - name: Checkout Refinery (Self)
        uses: actions/checkout@v4
        with:
          path: refinery

      # 2ï¸âƒ£ æ£€å‡ºå¤§å¸ˆé€»è¾‘ (Masters-Council) - ç§æœ‰åº“ï¼Œéœ€è¦ PAT
      - name: Checkout Masters (Logic)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Masters-Council
          token: ${{ secrets.GH_PAT }}
          path: masters_repo

      # 3ï¸âƒ£ æ£€å‡ºä¸­å¤®é“¶è¡Œ (Central-Bank) - ç§æœ‰åº“ï¼Œéœ€è¦ PAT
      - name: Checkout Vault (Storage)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.GH_PAT }}
          path: vault

      # 4ï¸âƒ£ ç¯å¢ƒå‡†å¤‡ï¼šæŠŠå¤§å¸ˆé€»è¾‘ "å®‰è£…" åˆ°åŠ å·¥å‚é‡Œ
      - name: Install Masters Plugin
        run: |
          # åˆ›å»ºå­˜æ”¾æ’ä»¶çš„ç›®å½•
          mkdir -p refinery/masters
          # å°†ç§æœ‰åº“é‡Œçš„å¤§å¸ˆä»£ç å¤åˆ¶è¿‡å»
          cp -r masters_repo/masters/*.py refinery/masters/
          echo "âœ… å¤§å¸ˆé€»è¾‘å·²è£…è½½ï¼š"
          ls -l refinery/masters/

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install pandas pyarrow supabase PyGithub

      # 5ï¸âƒ£ å¯åŠ¨è®¤çŸ¥å·¥å‚
      - name: Run Cognitive Factory
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          cd refinery
          # è¿è¡Œè°ƒåº¦è„šæœ¬ï¼Œå¼€å§‹åŠ å·¥æœ€è¿‘1å°æ—¶çš„æ•°æ®
          python run_factory.py

      # 6ï¸âƒ£ èµ„äº§å…¥åº“ï¼šå°†ç”Ÿæˆçš„ jsonl æ¨é€åˆ°ä¸­å¤®é“¶è¡Œ
      - name: Ship to Central Bank
        run: |
          cd vault
          # é…ç½® Bot èº«ä»½
          git config --global user.name "Cognitive Bot"
          git config --global user.email "bot@wenfp108.com"
          
          # æ£€æŸ¥ instructions æ–‡ä»¶å¤¹æ˜¯å¦æœ‰å˜åŠ¨
          if [[ -n $(git status -s instructions/) ]]; then
            git add instructions/
            git commit -m "ğŸ§  Cognitive Audit: New insights generated from hash_id"
            git push
            echo "âœ… è®¤çŸ¥èµ„äº§å·²æŠ¼è¿è‡³ä¸­å¤®é“¶è¡Œã€‚"
          else
            echo "ğŸ’¤ æœ¬è½®å¤§å¸ˆæ²¡æœ‰äº§ç”Ÿæ–°è§è§£ (æ— å˜åŠ¨)ã€‚"
          fi
