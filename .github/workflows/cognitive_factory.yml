name: ğŸ§  Cognitive Factory (Scheduled)

# ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šå–æ¶ˆäº‹ä»¶ç›‘å¬ï¼Œæ”¹ä¸ºå›ºå®š 2 å°æ—¶æ­¥è¿›
on:
  schedule:
    # æ¯ 2 å°æ—¶è¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´ï¼š0, 2, 4, 6...)
    # è¿™æ ·å¯ä»¥ç¡®ä¿ä½ çš„ 300 å…ƒä½™é¢èƒ½æ’‘æ›´ä¹…ï¼Œä¸”å¤§å¸ˆæœ‰è¶³å¤Ÿçš„æ—¶é—´ç§¯ç´¯â€œé¢„æœŸå·®â€
    - cron: '0 */2 * * *'
  
  # ä¿ç•™æ‰‹åŠ¨æŒ‰é’®ï¼Œæ–¹ä¾¿ä½ éšæ—¶æƒ³çœ‹æŠ¥å‘Šæ—¶æ‰‹åŠ¨ç‚¹å‡»æ‰§è¡Œ
  workflow_dispatch: 

jobs:
  audit_and_ship:
    # ç§»é™¤ä¹‹å‰çš„ if æ¡ä»¶ï¼Œå› ä¸ºç°åœ¨æ˜¯ç‹¬ç«‹è¿è¡Œ
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1ï¸âƒ£ æ£€å‡ºåŠ å·¥å‚ (Refinery-Engine)
      - name: Checkout Refinery (Self)
        uses: actions/checkout@v4
        with:
          path: refinery

      # 2ï¸âƒ£ æ£€å‡ºå¤§å¸ˆé€»è¾‘ (Masters-Council)
      - name: Checkout Masters (Logic)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Masters-Council
          token: ${{ secrets.GH_PAT }}
          path: masters_repo

      # 3ï¸âƒ£ æ£€å‡ºä¸­å¤®é“¶è¡Œ (Central-Bank)
      - name: Checkout Vault (Storage)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.GH_PAT }}
          path: vault

      # 4ï¸âƒ£ ç¯å¢ƒå‡†å¤‡
      - name: Setup Environment
        run: |
          mkdir -p refinery/masters
          cp -r masters_repo/masters/*.py refinery/masters/
          echo "âœ… å¤§å¸ˆæ’ä»¶è£…è½½å®Œæ¯•"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install pandas pyarrow supabase PyGithub requests pytz

      # 5ï¸âƒ£ å¯åŠ¨è®¤çŸ¥å·¥å‚
      - name: Run Cognitive Factory
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SILICON_FLOW_KEY: ${{ secrets.SILICON_FLOW_KEY }} 
        run: |
          cd refinery
          # è¿è¡Œä½ çš„è°ƒåº¦è„šæœ¬
          python run_factory.py

      # 6ï¸âƒ£ èµ„äº§å…¥åº“
      - name: Ship to Central Bank
        run: |
          cd vault
          # 1. å¼ºåˆ¶å£°æ˜èº«ä»½ (è§£å†³ Author identity unknown)
          git config user.name "Cognitive Bot"
          git config user.email "bot@wenfp108.com"
          
          # 2. æ£€æŸ¥æ˜¯å¦æœ‰æ–°äº§å‡ºçš„ .jsonl
          if [[ -n $(git status -s instructions/) ]]; then
            # 3. æš‚å­˜å¹¶æäº¤æœ¬åœ°æ”¹åŠ¨ (è¿™ 1184 æ¡å°±åœ¨è¿™)
            git add instructions/
            git commit -m "ğŸ§  Cognitive Audit: Batch update at $(date +'%Y-%m-%d %H:%M')"
            
            # 4. å…³é”®ï¼šå¼ºåˆ¶æ‹‰å–å¹¶ç”¨ rebase è§£å†³ [rejected] å†²çª
            # è¿™ä¼šæŠŠä½ çš„è¿™ 1184 æ¡æ•°æ®â€œæ¥â€åœ¨ä»“åº“æœ€æ–°ç‰ˆæœ¬çš„åé¢
            echo "ğŸ”„ å‘ç°è¿œç¨‹æ›´æ–°ï¼Œæ­£åœ¨æ‰§è¡Œ Rebase åŒæ­¥..."
            git pull origin main --rebase
            
            # 5. æ¨é€
            git push origin main
            echo "âœ… 1184+ æ¡è®¤çŸ¥èµ„äº§å·²å®‰å…¨å…¥åº“ä¸­å¤®é“¶è¡Œã€‚"
          else
            echo "ğŸ’¤ æœ¬è½®æ— æ–°ä¿¡å·ç”Ÿæˆï¼ŒAPI ä½™é¢å·²å—å»é‡é€»è¾‘ä¿æŠ¤ã€‚"
          fi
