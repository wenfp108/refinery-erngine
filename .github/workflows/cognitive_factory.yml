name: ğŸ§  Cognitive Factory (Scheduled)

# ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šå–æ¶ˆäº‹ä»¶ç›‘å¬ï¼Œæ”¹ä¸ºå›ºå®š 2 å°æ—¶æ­¥è¿›
on:
  schedule:
    # æ¯ 2 å°æ—¶è¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´ï¼š0, 2, 4, 6...)
    # è¿™æ ·å¯ä»¥ç¡®ä¿ä½ çš„ 300 å…ƒä½™é¢èƒ½æ’‘æ›´ä¹…ï¼Œä¸”å¤§å¸ˆæœ‰è¶³å¤Ÿçš„æ—¶é—´ç§¯ç´¯â€œé¢„æœŸå·®â€
    - cron: '0 */2 * * *'
  
  # ä¿ç•™æ‰‹åŠ¨æŒ‰é’®ï¼Œæ–¹ä¾¿ä½ éšæ—¶æƒ³çœ‹æŠ¥å‘Šæ—¶æ‰‹åŠ¨ç‚¹å‡»æ‰§è¡Œ
  workflow_dispatch: 

jobs:
  audit_and_ship:
    # ç§»é™¤ä¹‹å‰çš„ if æ¡ä»¶ï¼Œå› ä¸ºç°åœ¨æ˜¯ç‹¬ç«‹è¿è¡Œ
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1ï¸âƒ£ æ£€å‡ºåŠ å·¥å‚ (Refinery-Engine)
      - name: Checkout Refinery (Self)
        uses: actions/checkout@v4
        with:
          path: refinery

      # 2ï¸âƒ£ æ£€å‡ºå¤§å¸ˆé€»è¾‘ (Masters-Council)
      - name: Checkout Masters (Logic)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Masters-Council
          token: ${{ secrets.GH_PAT }}
          path: masters_repo

      # 3ï¸âƒ£ æ£€å‡ºä¸­å¤®é“¶è¡Œ (Central-Bank)
      - name: Checkout Vault (Storage)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.GH_PAT }}
          path: vault

      # 4ï¸âƒ£ ç¯å¢ƒå‡†å¤‡
      - name: Setup Environment
        run: |
          mkdir -p refinery/masters
          cp -r masters_repo/masters/*.py refinery/masters/
          echo "âœ… å¤§å¸ˆæ’ä»¶è£…è½½å®Œæ¯•"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install pandas pyarrow supabase PyGithub requests pytz

      # 5ï¸âƒ£ å¯åŠ¨è®¤çŸ¥å·¥å‚
      - name: Run Cognitive Factory
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SILICON_FLOW_KEY: ${{ secrets.SILICON_FLOW_KEY }} 
        run: |
          cd refinery
          # è¿è¡Œä½ çš„è°ƒåº¦è„šæœ¬
          python run_factory.py

      # 6ï¸âƒ£ èµ„äº§å…¥åº“
      - name: Ship to Central Bank
        run: |
          cd vault
          git config --global user.name "Cognitive Bot"
          git config --global user.email "bot@wenfp108.com"
          
          # æ£€æŸ¥ä»Šæ—¥åˆ†å·æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–° (teachings_YYYYMMDD_HH.jsonl)
          if [[ -n $(git status -s instructions/) ]]; then
            git add instructions/
            git commit -m "ğŸ§  Cognitive Audit: Batch processing at $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… é¡¶çº§è®¤çŸ¥èµ„äº§å·²è¿½åŠ è‡³ä¸­å¤®é“¶è¡Œåˆ†å·ã€‚"
          else
            echo "ğŸ’¤ æœ¬è½®æœªå‘ç°æ–°ä¿¡å·ã€‚å»é‡é€»è¾‘ä¿æŠ¤äº†ä½ çš„ API ä½™é¢ã€‚"
          fi
